#  TerraformGoat – S3 Module Deep Dive

### Understanding S3 Bucket Misconfigurations Through Terraform

This section documents what is happening inside the S3 portion of the TerraformGoat project. The goal is to *learn hands-on IaC security* 
by analyzing intentionally vulnerable Terraform configurations.

TerraformGoat introduces various S3 buckets with different security postures so you can build intuition around:

* How S3 buckets are constructed in Terraform
* What constitutes insecure vs secure configuration
* How to detect issues (manually + using tools like Checkov/TFsec)
* Why these issues matter in real-world cloud security

---

##  High-Level Structure of This File

This Terraform module defines **multiple S3 buckets**, each meant to simulate different real-world scenarios:

| Resource Name                      | Purpose                                   | Security Posture                                                |
| ---------------------------------- | ----------------------------------------- | --------------------------------------------------------------- |
| `aws_s3_bucket.data`               | General data bucket                       | Public, no encryption, no versioning, no logging (*worst-case*) |
| `aws_s3_bucket_object.data_object` | Uploads sensitive file into `data` bucket | Sensitive data exposed                                          |
| `aws_s3_bucket.financials`         | Financial documents                       | Private but insecure (no SSE, versioning, logging)              |
| `aws_s3_bucket.operations`         | Operational data                          | Versioned but missing SSE/logging                               |
| `aws_s3_bucket.data_science`       | Data science workloads                    | Logged + versioned but missing SSE                              |
| `aws_s3_bucket.logs`               | Central logging bucket                    | **Secure** (SSE-KMS, versioning, proper ACL)                    |

TerraformGoat intentionally gives each bucket a different (usually flawed) configuration so you learn how to identify misconfigurations and 
apply secure patterns.

---

##  Shared Concepts Found Across All Buckets

Before diving into each bucket individually, it’s important to understand the repeating Terraform patterns:

###  1. Naming Convention

All buckets follow:

```hcl
"${local.resource_prefix.value}-<bucket-name>"
```

This allows:

* Clear environment or application grouping
* Easy resource tracking
* Template-style deployments (dev, staging, prod)

---

###  2. `force_destroy = true`

Every bucket includes:

```hcl
force_destroy = true
```

Meaning:

* Terraform deletes the bucket **even if objects exist**.
* Prevents “BucketNotEmpty” errors during `terraform destroy`.
* Useful in labs, **dangerous in production**.

Real-world risk:

> Accidental destroy wipes critical data instantly.

---

###  3. Traceability Tags (Git/Yor Metadata)

Most resources use:

```hcl
tags = merge({
  Name = ...
  Environment = ...
}, {
  git_commit = ...
  git_file = ...
  yor_trace = ...
})
```

These fields provide:

* Commit ID
* Git repo name
* Modified-by user
* File path
* Unique Yor trace ID

This is a production-grade practise for **IaC provenance tracking**, ensuring every cloud resource links back to the code + commit that created it.

---

###  4. Absence or Presence of Key S3 Security Controls

The file purposely toggles these settings on/off to teach detection:

| Control                          | Purpose                                   | Missing In                                 |
| -------------------------------- | ----------------------------------------- | ------------------------------------------ |
| **Server-side encryption (SSE)** | Protects at-rest data                     | data, financials, operations, data_science |
| **Versioning**                   | Prevents ransomware/accidental overwrites | data, financials                           |
| **Access Logging**               | Detects who accessed what                 | data, financials, operations               |
| **Public access settings**       | Controls anonymity                        | `data` (comment indicates public access)   |

The idea:
Learn how a lack of these settings exposes organizations to lateral movement, ransomware, data leaks, and compliance failures.

---

#  S3 Buckets – Detailed Notes (Part 1)

We now begin documenting buckets **one by one**, starting at the top of the file.

---

# 1️⃣ Bucket: `aws_s3_bucket.data`

##  Purpose

A general-purpose bucket used to store application or customer data.

This is the **most insecure bucket** in the file and is intentionally configured to demonstrate common S3 misconfigurations 
leading to public data leaks.

---

##  Terraform Definition (Simplified)

```hcl
resource "aws_s3_bucket" "data" {
  # bucket is public
  # bucket is not encrypted
  # bucket does not have access logs
  # bucket does not have versioning
  bucket        = "${local.resource_prefix.value}-data"
  force_destroy = true
  tags          = merge(...)
}
```

---

##  Key Characteristics & Misconfigurations

###  The bucket is “public”

The comment indicates:

> Bucket is public

While not shown here (policy likely defined elsewhere), this means:

* **Anyone on the internet can access it**
* Objects may be world-readable
* Perfect for data exposure labs

Real-world impact:

* Sensitive customer files become openly downloadable
* Attackers can use bucket enumeration tools (`aws s3 ls s3://bucketname` when misconfigured)

---

###  No server-side encryption (SSE)

No block like:

```hcl
server_side_encryption_configuration { ... }
```

Meaning:

* Data at rest is stored in plaintext at AWS S3 layer
* Violates CIS, PCI-DSS, HIPAA, GDPR, ISO27001, etc.

---

###  No versioning

Missing:

```hcl
versioning { enabled = true }
```

Implications:

* Accidental deletes are permanent
* Ransomware or malicious insiders can overwrite objects with no recovery
* Sensitive files like `customer-master.xlsx` can be tampered with silently

---

###  No access logs

Missing:

```hcl
logging {
  target_bucket = ...
}
```

Meaning:

* You cannot investigate who accessed/downloaded what
* Makes post-incident forensics difficult
* Attackers can exfiltrate data without leaving traces

---

##  Complete Risk Summary

| Risk                    | Severity     | Why                                    |
| ----------------------- | ------------ | -------------------------------------- |
| Public access           | **Critical** | Anyone can download data               |
| No encryption           | High         | Data stored unprotected at rest        |
| No logging              | High         | Impossible to audit/explain compromise |
| No versioning           | Medium       | No file history or recovery            |
| Sensitive file uploaded | **Critical** | Customer data exposed                  |

This bucket represents a **classic real-world misconfiguration** leading to S3 breaches.

---

# Object Upload: `aws_s3_bucket_object.data_object`

This resource uploads:

```
customer-master.xlsx
```

into the insecure `data` bucket.

