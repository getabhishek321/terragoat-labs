########################################
# Secure S3 + KMS Setup (Rectified)
#
# This file is a hardened version of the
# original vulnerable s3.tf from TerraGoat.
#
# For each bucket we document:
# - PREVIOUSLY: what was vulnerable
# - FIX: what we changed to secure it
########################################

########################################
# KMS KEYS
########################################

# FIX: Introduced a dedicated KMS key for general S3 data encryption.
# PREVIOUSLY: Only the logs bucket used a KMS key; other buckets had no SSE at all.
resource "aws_kms_key" "s3_data_key" {
  description             = "KMS CMK for application S3 buckets (data, financials, operations, data_science)"
  deletion_window_in_days = 30

  tags = {
    Name        = "${local.resource_prefix.value}-s3-data-key"
    Environment = local.resource_prefix.value
  }
}

# This key already existed conceptually in the original file (referenced by logs bucket).
# We keep it explicitly defined here for completeness and clarity.
resource "aws_kms_key" "logs_key" {
  description             = "KMS CMK for S3 access logs bucket"
  deletion_window_in_days = 30

  tags = {
    Name        = "${local.resource_prefix.value}-logs-key"
    Environment = local.resource_prefix.value
  }
}

########################################
# LOGS BUCKET (REFERENCE SECURE PATTERN)
########################################

resource "aws_s3_bucket" "logs" {
  bucket = "${local.resource_prefix.value}-logs"

  # PREVIOUSLY: This part was already mostly secure in the original file.
  # FIX: Kept as the baseline "good" example and added minor clarifying comments.

  # ACL allows S3 logging service to write logs, but does not expose data publicly.
  acl = "log-delivery-write"

  versioning {
    enabled = true
  }

  # FIX: Default encryption with KMS CMK.
  # PREVIOUSLY: Already using aws:kms - we are keeping that good practice.
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.logs_key.arn
      }
    }
  }

  # ⚠ LAB-ONLY:
  # PREVIOUSLY: force_destroy = true could cause log loss on destroy.
  # FIX (recommended for prod): set this to false.
  # Kept as true here ONLY because this is a training/lab environment.
  force_destroy = true

  tags = merge({
    Name        = "${local.resource_prefix.value}-logs"
    Environment = local.resource_prefix.value
  }, {
    git_commit           = "d68d2897add9bc2203a5ed0632a5cdd8ff8cefb0"
    git_file             = "terraform/aws/s3.tf"
    git_last_modified_at = "2020-06-16 14:46:24"
    git_last_modified_by = "nimrodkor@gmail.com"
    git_modifiers        = "nimrodkor"
    git_org              = "bridgecrewio"
    git_repo             = "terragoat"
    yor_trace            = "01946fe9-aae2-4c99-a975-e9b0d3a4696c"
  })
}

# FIX: Block any form of public access at account/bucket level for logs.
resource "aws_s3_bucket_public_access_block" "logs" {
  bucket = aws_s3_bucket.logs.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

########################################
# DATA BUCKET (originally public, unencrypted)
########################################

resource "aws_s3_bucket" "data" {
  bucket = "${local.resource_prefix.value}-data"

  # PREVIOUSLY: Comment said "bucket is public" and there was no ACL/public access block.
  # FIX: Enforce private bucket ACL and block all public access.
  acl = "private"

  # FIX: Enable versioning for recovery and forensic value.
  # PREVIOUSLY: Bucket did not have versioning.
  versioning {
    enabled = true
  }

  # FIX: Enable server-side encryption with KMS.
  # PREVIOUSLY: Bucket was not encrypted at all.
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.s3_data_key.arn
      }
    }
  }

  # FIX: Send access logs to the central logs bucket.
  # PREVIOUSLY: Bucket did not have access logs.
  logging {
    target_bucket = aws_s3_bucket.logs.id
    target_prefix = "data/"
  }

  # ⚠ LAB-ONLY:
  # PREVIOUSLY: force_destroy = true on a bucket with sensitive customer data is very dangerous.
  # FIX (recommended for prod): set this to false. Kept true only for training.
  force_destroy = true

  tags = merge({
    Name        = "${local.resource_prefix.value}-data"
    Environment = local.resource_prefix.value
  }, {
    git_commit           = "4d57f83ca4d3a78a44fb36d1dcf0d23983fa44f5"
    git_file             = "terraform/aws/s3.tf"
    git_last_modified_at = "2022-05-18 07:08:06"
    git_last_modified_by = "nimrod@bridgecrew.io"
    git_modifiers        = "34870196+LironElbaz/nimrod/nimrodkor"
    git_org              = "bridgecrewio"
    git_repo             = "terragoat"
    yor_trace            = "0874007d-903a-4b4c-945f-c9c233e13243"
  })
}

# FIX: Explicitly block any kind of public access on the data bucket.
# PREVIOUSLY: Bucket was described as public and could lead to S3 data leaks.
resource "aws_s3_bucket_public_access_block" "data" {
  bucket = aws_s3_bucket.data.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

########################################
# CUSTOMER MASTER OBJECT (now in a secure bucket)
########################################

resource "aws_s3_bucket_object" "data_object" {
  bucket = aws_s3_bucket.data.id
  key    = "customer-master.xlsx"
  source = "resources/customer-master.xlsx"

  # PREVIOUSLY: This object was placed into a public, unencrypted, unlogged bucket.
  # FIX: Now inherits private ACL, encryption, logging, and versioning from the secured data bucket.

  tags = merge({
    Name        = "${local.resource_prefix.value}-customer-master"
    Environment = local.resource_prefix.value
  }, {
    git_commit           = "d68d2897add9bc2203a5ed0632a5cdd8ff8cefb0"
    git_file             = "terraform/aws/s3.tf"
    git_last_modified_at = "2020-06-16 14:46:24"
    git_last_modified_by = "nimrodkor@gmail.com"
    git_modifiers        = "nimrodkor"
    git_org              = "bridgecrewio"
    git_repo             = "terragoat"
    yor_trace            = "a7f01cc7-63c2-41a8-8555-6665e5e39a64"
  })
}

########################################
# FINANCIALS BUCKET (was private but non-compliant)
########################################

resource "aws_s3_bucket" "financials" {
  bucket = "${local.resource_prefix.value}-financials"

  # PREVIOUSLY: acl = "private" but no SSE, no versioning, no logging.
  # FIX: Keep private ACL and add full hardening.
  acl = "private"

  # FIX: Enable SSE-KMS for financial records.
  # PREVIOUSLY: Bucket was not encrypted.
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.s3_data_key.arn
      }
    }
  }

  # FIX: Enable versioning for recovery, IR, and compliance.
  # PREVIOUSLY: Bucket did not have versioning.
  versioning {
    enabled = true
  }

  # FIX: Enable access logging to central logs bucket.
  # PREVIOUSLY: Bucket did not have access logs.
  logging {
    target_bucket = aws_s3_bucket.logs.id
    target_prefix = "financials/"
  }

  # ⚠ LAB-ONLY:
  # PREVIOUSLY: force_destroy = true on financial data is dangerous.
  # FIX (prod): set to false, keep true here for lab simplicity.
  force_destroy = true

  tags = merge({
    Name        = "${local.resource_prefix.value}-financials"
    Environment = local.resource_prefix.value
  }, {
    git_commit           = "d68d2897add9bc2203a5ed0632a5cdd8ff8cefb0"
    git_file             = "terraform/aws/s3.tf"
    git_last_modified_at = "2020-06-16 14:46:24"
    git_last_modified_by = "nimrodkor@gmail.com"
    git_modifiers        = "nimrodkor"
    git_org              = "bridgecrewio"
    git_repo             = "terragoat"
    yor_trace            = "0e012640-b597-4e5d-9378-d4b584aea913"
  })
}

resource "aws_s3_bucket_public_access_block" "financials" {
  bucket = aws_s3_bucket.financials.id

  # FIX: Explicitly prevent any accidental public exposure.
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

########################################
# OPERATIONS BUCKET (had versioning but missing SSE/logging)
########################################

resource "aws_s3_bucket" "operations" {
  bucket = "${local.resource_prefix.value}-operations"

  # PREVIOUSLY: acl = "private", versioning enabled, but no SSE and no logging.
  # FIX: Keep private ACL and improve security.
  acl = "private"

  versioning {
    enabled = true
  }

  # FIX: Add SSE-KMS for operational artifacts.
  # PREVIOUSLY: Bucket was not encrypted.
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.s3_data_key.arn
      }
    }
  }

  # FIX: Enable access logging.
  # PREVIOUSLY: Bucket did not have access logs.
  logging {
    target_bucket = aws_s3_bucket.logs.id
    target_prefix = "operations/"
  }

  # ⚠ LAB-ONLY:
  force_destroy = true

  tags = merge({
    Name        = "${local.resource_prefix.value}-operations"
    Environment = local.resource_prefix.value
  }, {
    git_commit           = "d68d2897add9bc2203a5ed0632a5cdd8ff8cefb0"
    git_file             = "terraform/aws/s3.tf"
    git_last_modified_at = "2020-06-16 14:46:24"
    git_last_modified_by = "nimrodkor@gmail.com"
    git_modifiers        = "nimrodkor"
    git_org              = "bridgecrewio"
    git_repo             = "terragoat"
    yor_trace            = "29efcf7b-22a8-4bd6-8e14-1f55b3a2d743"
  })
}

resource "aws_s3_bucket_public_access_block" "operations" {
  bucket = aws_s3_bucket.operations.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

########################################
# DATA SCIENCE BUCKET (had versioning + logging, but no SSE)
########################################

resource "aws_s3_bucket" "data_science" {
  bucket = "${local.resource_prefix.value}-data-science"

  # PREVIOUSLY: acl = "private", versioning + logging enabled, but no SSE.
  # FIX: Keep good parts and add encryption.
  acl = "private"

  versioning {
    enabled = true
  }

  logging {
    target_bucket = aws_s3_bucket.logs.id
    target_prefix = "data-science/"
  }

  # FIX: Add SSE-KMS to protect datasets and ML artifacts.
  # PREVIOUSLY: Bucket was not encrypted.
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.s3_data_key.arn
      }
    }
  }

  # ⚠ LAB-ONLY:
  force_destroy = true

  tags = {
    git_commit           = "d68d2897add9bc2203a5ed0632a5cdd8ff8cefb0"
    git_file             = "terraform/aws/s3.tf"
    git_last_modified_at = "2020-06-16 14:46:24"
    git_last_modified_by = "nimrodkor@gmail.com"
    git_modifiers        = "nimrodkor"
    git_org              = "bridgecrewio"
    git_repo             = "terragoat"
    yor_trace            = "9a7c8788-5655-4708-bbc3-64ead9847f64"
  }
}

resource "aws_s3_bucket_public_access_block" "data_science" {
  bucket = aws_s3_bucket.data_science.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
